---
layout: ‘ew
title: 微信支付
date: 2017-04-21 14:48:03
tags:
- 支付
categories: [Android]
---

微信支付踩坑记录全过程
<!-- more -->

# 申请地址

[微信开放平台](https://open.weixin.qq.com)

# 业务流程图

![流程图](http://i4.buimg.com/4851/e6163446c2ec4377.png)

# 关键步骤

* 获取微信支付APPID
* 添加微信支付依赖包
	> libammsdk.jar
	> 或者
	> compile 'com.tencent.mm.opensdk:wechat-sdk-android-with-mta:+'
* 创建一个WXPayEntryActivity.java类，用于显示支付状态。

# 具体实现

* 在开发平台创建一个APP，拿到APPID
* 导入依赖包
* 创建一个WXPayEntryActivity.java 

1.在AndroidManifest.xml 添加
```xml
<activity
    android:name=".wxapi.WXPayEntryActivity"
    android:configChanges="keyboardHidden|orientation|screenSize"
    android:exported="true"
    android:screenOrientation="portrait"
    android:theme="@android:style/Theme.Translucent.NoTitleBar">
    <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <data android:scheme="sdksample"/>
    </intent-filter>
</activity>
```
2.WXPayEntryActivity.java 类
```Java
public class WXPayEntryActivity extends Activity implements IWXAPIEventHandler {

    private IWXAPI mPayAPI;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        mPayAPI = WXAPIFactory.createWXAPI(this, Config.WX_APP_ID, false);
        mPayAPI.handleIntent(getIntent(), this);
    }

    @Override
    protected void onNewIntent(Intent intent) {
        super.onNewIntent(intent);
        setIntent(intent);
        mPayAPI.handleIntent(intent, this);
        finish();
    }

    @Override
    public void onReq(BaseReq baseReq) {

    }

    @Override
    public void onResp(BaseResp baseResp) {
        if (baseResp.getType() == ConstantsAPI.COMMAND_PAY_BY_WX) {
            if (baseResp.errCode == 0) {
                //支付成功

            } else {
                //支付失败
                // -1 : 可能的原因：签名错误、未注册APPID、项目设置APPID不正确、注册的APPID与设置的不匹配、其他异常等
                // -2 : 用户取消

            }
        }
    }
}
```
3.发起微信支付
```Java
private IWXAPI init() {
    IWXAPI iwxapi = WXAPIFactory.createWXAPI(activity, appId, false);
    if (iwxapi.isWXAppInstalled() && iwxapi.isWXAppSupportAPI() && iwxapi.registerApp(appId)) {
        return iwxapi;
    }
    return null;
}

public void pay(final Callback callBack) {
    new Thread(new Runnable() {
        @Override
        public void run() {
            IWXAPI iwxapi = init();
            if (iwxapi == null) {
                if (callBack != null)
                    callBack.onFailed();
                return;
            }
            PayReq request = new PayReq();
            request.appId = Config.WX_APP_ID; // APPID
            request.partnerId = "1900000109"; // 商户号
            request.prepayId = "1101000000140415649af9fc314aa427"; // 预支付交易会话ID
            request.packageValue = "Sign=WXPay"; // 扩展字段 固定
            request.nonceStr = "1101000000140429eb40476f8896f4c9"; // 随机字符串
            request.timeStamp = "1398746574"; // 时间戳
            request.sign = "7FFECB600D7157C5AA49810D2D8F28BC2811827B"; // 签名
            if (!iwxapi.sendReq(request)) {
                if (callBack != null)
                    callBack.onFailed();
            } else {
                if (callBack != null)
                    callBack.onSuccess();
            }
        }
    }).start();
}
```

# 注意事项

* 1. WXPayEntryActivity.java 文件必须放在，packagename.wxapi的文件夹中，效果如下：
![目录结构](http://i2.muimg.com/4851/b8b73501d6fe19c4.png)

